/// @ 0.19.0

// ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒ«ã‚³ãƒ•é€£é–æ–‡ç« ç”Ÿæˆ
// Misskey Play ã¾ãŸã¯ AiScript Scratchpad ã§å®Ÿè¡Œã—ã¦ãã ã•ã„

// ============================================
// è¨­å®š
// ============================================

// å–å¾—ã™ã‚‹ãƒãƒ¼ãƒˆæ•°ï¼ˆ1-100ï¼‰
let FETCH_LIMIT = 50

// ç”Ÿæˆã™ã‚‹æ–‡ç« æ•°
let GENERATE_COUNT = 3

// ============================================
// ãƒ†ã‚­ã‚¹ãƒˆå‡¦ç†é–¢æ•°
// ============================================

@clean_text(text) {
	var t = text

	// æ”¹è¡Œã‚’ã‚¹ãƒšãƒ¼ã‚¹ã«
	t = t.replace(Str:lf, " ")

	// é€£ç¶šã‚¹ãƒšãƒ¼ã‚¹ã‚’1ã¤ã«
	loop {
		let before = t
		t = t.replace("  ", " ")
		if before == t break
	}

	return t.trim()
}

// N-gramç”Ÿæˆï¼ˆ2æ–‡å­—å˜ä½ï¼‰
@make_ngrams(text) {
	let chars = text.to_arr()
	var ngrams = {}

	for let i, (chars.len - 2) {
		let key = `{chars.at(i)}{chars.at(i + 1)}`
		let next = chars.at(i + 2)

		if Obj:has(ngrams, key) {
			let arr = ngrams[key]
			arr.push(next)
		} else {
			ngrams[key] = [next]
		}
	}

	return ngrams
}

// è¤‡æ•°ã®N-gramã‚’ãƒãƒ¼ã‚¸
@merge_ngrams(ng1, ng2) {
	var result = ng1
	let keys = Obj:keys(ng2)

	each let key, keys {
		if Obj:has(result, key) {
			let arr1 = result[key]
			let arr2 = ng2[key]
			each let item, arr2 {
				arr1.push(item)
			}
			result[key] = arr1
		} else {
			result[key] = ng2[key]
		}
	}

	return result
}

// æ–‡ç« ç”Ÿæˆ
@generate(ngrams, max_len) {
	let keys = Obj:keys(ngrams)
	if keys.len == 0 return "ãƒ‡ãƒ¼ã‚¿ä¸è¶³"

	// ãƒ©ãƒ³ãƒ€ãƒ ãªé–‹å§‹ç‚¹
	var text = keys.at(Math:rnd(0, keys.len - 1))

	for let i, max_len {
		let chars = text.to_arr()
		if chars.len < 2 break

		let key = `{chars.at(chars.len - 2)}{chars.at(chars.len - 1)}`

		if !Obj:has(ngrams, key) break

		let candidates = ngrams[key]
		let next = candidates.at(Math:rnd(0, candidates.len - 1))
		text = `{text}{next}`

		// å¥ç‚¹ã§çµ‚äº†
		if (next == "ã€‚" || next == "ï¼" || next == "ï¼Ÿ") && text.len > 10 {
			break
		}
	}

	return text
}

// ============================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†
// ============================================

<: "ğŸ“ ãƒãƒ«ã‚³ãƒ•é€£é–æ–‡ç« ç”Ÿæˆã‚’é–‹å§‹ã—ã¾ã™"
<: ""

// è‡ªåˆ†ã®ãƒãƒ¼ãƒˆã‚’å–å¾—ï¼ˆi/notesã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
<: `â³ ãƒãƒ¼ãƒˆã‚’å–å¾—ä¸­...ï¼ˆæœ€å¤§{FETCH_LIMIT}ä»¶ï¼‰`

// Mk:apiã¯è‡ªå‹•çš„ã«ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ä»˜ä¸ã—ã¾ã™
var notes = null

// ã¾ãš i/notes ã‚’è©¦ã™
notes = Mk:api("i/notes", { limit: FETCH_LIMIT })

// ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
if Core:type(notes) == "error" {
	<: `âŒ ã‚¨ãƒ©ãƒ¼: {notes.name}`
	<: "ğŸ’¡ ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Misskey Playã§å®Ÿè¡Œã—ã¦ãã ã•ã„"
	Core:abort("API Error")
}

<: `âœ… {notes.len}ä»¶ã®ãƒãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸ`
<: ""

// ãƒãƒ«ã‚³ãƒ•ãƒ¢ãƒ‡ãƒ«æ§‹ç¯‰
<: "ğŸ”¨ ãƒãƒ«ã‚³ãƒ•ãƒ¢ãƒ‡ãƒ«ã‚’æ§‹ç¯‰ä¸­..."

var all_ngrams = {}
var valid_count = 0

each let note, notes {
	if Core:type(note) == "obj" {
		if note["text"] != null {
			let text = note["text"]
			if text.len > 5 {
				let cleaned = clean_text(text)
				let ng = make_ngrams(cleaned)
				all_ngrams = merge_ngrams(all_ngrams, ng)
				valid_count = valid_count + 1
			}
		}
	}
}

let model_size = Obj:keys(all_ngrams).len
<: `âœ… {valid_count}ä»¶ã®ãƒãƒ¼ãƒˆã‹ã‚‰{model_size}å€‹ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å­¦ç¿’ã—ã¾ã—ãŸ`
<: ""

// æ–‡ç« ç”Ÿæˆ
<: "âœ¨ æ–‡ç« ã‚’ç”Ÿæˆã—ã¾ã™..."
<: ""
<: "--- ç”Ÿæˆã•ã‚ŒãŸæ–‡ç«  ---"
<: ""

for let i, GENERATE_COUNT {
	let text = generate(all_ngrams, 50)
	<: `{i + 1}. {text}`
	<: ""
}

<: "--- å®Œäº† ---"
<: ""
<: "ğŸ’¡ ã“ã®æ–‡ç« ã¯ã‚ãªãŸã®ãƒãƒ¼ãƒˆã‹ã‚‰å­¦ç¿’ã—ã¦ç”Ÿæˆã•ã‚Œã¾ã—ãŸ"
