/// @ 0.19.0

// é«˜åº¦ãªãƒãƒ«ã‚³ãƒ•é€£é–æ–‡ç« ç”Ÿæˆ for Misskey
// ã‚ˆã‚Šè‡ªç„¶ãªæ–‡ç« ã‚’ç”Ÿæˆã™ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³

// ============================================
// è¨­å®š
// ============================================

var CONFIG = {
	fetch_limit: 100        // å–å¾—ã™ã‚‹ãƒãƒ¼ãƒˆæ•°
	markov_order: 2         // N-gramã®Nï¼ˆ2ã¾ãŸã¯3ã‚’æ¨å¥¨ï¼‰
	max_length: 100         // ç”Ÿæˆã™ã‚‹æœ€å¤§é•·
	min_length: 10          // ç”Ÿæˆã™ã‚‹æœ€å°é•·
	generate_count: 5       // ç”Ÿæˆã™ã‚‹æ–‡ç« ã®æ•°
	use_word_tokens: true   // å˜èªå˜ä½ã§å‡¦ç†ã™ã‚‹ã‹
}

// ============================================
// ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// ============================================

@log(msg) {
	<: msg
}

@clean_note_text(text) {
	var cleaned = text

	// URLã‚’é™¤å»ï¼ˆç°¡æ˜“ç‰ˆï¼‰
	var parts = cleaned.split(" ")
	var filtered = []

	each let part, parts {
		var should_keep = true

		// URLã£ã½ã„ã‚‚ã®ã‚’é™¤å¤–
		if part.incl("http") || part.incl("https") || part.incl("://") {
			should_keep = false
		}

		// ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³é™¤å¤–
		if part.starts_with("@") && part.len > 1 {
			should_keep = false
		}

		// ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ã¯å«ã‚ã‚‹ï¼ˆ#ã¯é™¤å»ï¼‰
		if part.starts_with("#") && part.len > 1 {
			part = part.slice(1, part.len)
		}

		if should_keep && part.len > 0 {
			filtered.push(part)
		}
	}

	cleaned = filtered.join(" ")

	// æ”¹è¡Œã‚’ç©ºç™½ã«
	cleaned = cleaned.replace(Str:lf, " ")

	// é€£ç¶šç©ºç™½ã‚’1ã¤ã«
	var prev = ""
	loop {
		prev = cleaned
		cleaned = cleaned.replace("  ", " ")
		if prev == cleaned break
	}

	return cleaned.trim()
}

// ãƒˆãƒ¼ã‚¯ãƒ³åŒ–ï¼ˆæ–‡å­—ã¾ãŸã¯å˜èªå˜ä½ï¼‰
@tokenize(text, use_words) {
	if use_words {
		// å˜èªå˜ä½
		return text.split(" ")
	} else {
		// æ–‡å­—å˜ä½
		return text.to_arr()
	}
}

// N-gramãƒã‚§ãƒ¼ãƒ³ã®æ§‹ç¯‰
@build_chain(tokens, order) {
	var chain = {}

	if tokens.len <= order {
		return chain
	}

	for let i, (tokens.len - order) {
		// ã‚­ãƒ¼ã‚’ä½œæˆ
		var key_parts = []
		for let j, order {
			let token = tokens.at(i + j)
			if token != null {
				key_parts.push(token)
			}
		}

		if key_parts.len == order {
			let key = key_parts.join("â”‚")
			let next_token = tokens.at(i + order)

			if next_token != null {
				if Obj:has(chain, key) {
					let arr = chain[key]
					arr.push(next_token)
				} else {
					chain[key] = [next_token]
				}
			}
		}
	}

	return chain
}

// ãƒã‚§ãƒ¼ãƒ³ã‚’ãƒãƒ¼ã‚¸
@merge_chains(chain1, chain2) {
	var result = chain1
	let keys = Obj:keys(chain2)

	each let key, keys {
		if Obj:has(result, key) {
			let arr1 = result[key]
			let arr2 = chain2[key]
			each let item, arr2 {
				arr1.push(item)
			}
			result[key] = arr1
		} else {
			result[key] = chain2[key]
		}
	}

	return result
}

// é–‹å§‹ã‚­ãƒ¼ã‚’é¸æŠï¼ˆãªã‚‹ã¹ãæ–‡ã®å§‹ã¾ã‚Šã£ã½ã„ã‚‚ã®ï¼‰
@select_start_key(keys) {
	var good_starts = []

	each let key, keys {
		let first_char = key.to_arr().at(0)
		// å¤§æ–‡å­—ã‚„æ—¥æœ¬èªã§å§‹ã¾ã‚‹ã‚‚ã®ã‚’å„ªå…ˆ
		if first_char != " " && first_char != "ã€" && first_char != "ã€‚" {
			good_starts.push(key)
		}
	}

	if good_starts.len > 0 {
		return good_starts.at(Math:rnd(0, good_starts.len - 1))
	} else {
		return keys.at(Math:rnd(0, keys.len - 1))
	}
}

// æ–‡ç« ç”Ÿæˆ
@generate_text(chain, order, max_len, min_len, use_words) {
	let keys = Obj:keys(chain)

	if keys.len == 0 {
		return "âš ï¸ å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™"
	}

	// é–‹å§‹ã‚­ãƒ¼ã‚’é¸æŠ
	let start_key = select_start_key(keys)
	var tokens = start_key.split("â”‚")

	var current_key = start_key

	// æ–‡ç« ã‚’ç”Ÿæˆ
	for let i, max_len {
		if !Obj:has(chain, current_key) {
			break
		}

		let candidates = chain[current_key]
		if candidates.len == 0 {
			break
		}

		// æ¬¡ã®ãƒˆãƒ¼ã‚¯ãƒ³ã‚’é¸æŠ
		let next_token = candidates.at(Math:rnd(0, candidates.len - 1))
		tokens.push(next_token)

		// æ¬¡ã®ã‚­ãƒ¼ã‚’ä½œæˆ
		if tokens.len >= order {
			var key_parts = []
			for let j, order {
				let idx = tokens.len - order + j
				key_parts.push(tokens.at(idx))
			}
			current_key = key_parts.join("â”‚")
		}

		// çµ‚äº†æ¡ä»¶ï¼šå¥ç‚¹ã§çµ‚ã‚ã‚‹
		let is_end = (next_token == "ã€‚" || next_token == "ï¼" || next_token == "ï¼Ÿ" ||
		              next_token == "." || next_token == "!" || next_token == "?")

		if is_end {
			let result_text = if use_words tokens.join(" ") else tokens.join("")
			if result_text.len >= min_len {
				break
			}
		}
	}

	// ãƒˆãƒ¼ã‚¯ãƒ³ã‚’çµåˆ
	let result = if use_words tokens.join(" ") else tokens.join("")
	return result
}

// ============================================
// ãƒ¡ã‚¤ãƒ³å‡¦ç†
// ============================================

log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
log("ğŸ“š ãƒãƒ«ã‚³ãƒ•é€£é–æ–‡ç« ç”Ÿæˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ")
log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
log("")

// 1. ãƒãƒ¼ãƒˆã‚’å–å¾—
log(`ğŸ“¥ ãƒãƒ¼ãƒˆã‚’å–å¾—ä¸­... (æœ€å¤§ {CONFIG.fetch_limit} ä»¶)`)

let notes = Mk:api("i/notes", {
	limit: CONFIG.fetch_limit
})

if Core:type(notes) == "error" {
	log(`âŒ ã‚¨ãƒ©ãƒ¼: {notes.name}`)
	log("ğŸ’¡ ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯Misskey Playã§å®Ÿè¡Œã—ã¦ãã ã•ã„")
	Core:abort("APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼")
}

log(`âœ… {notes.len} ä»¶ã®ãƒãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸ`)
log("")

// 2. ãƒãƒ«ã‚³ãƒ•ãƒã‚§ãƒ¼ãƒ³æ§‹ç¯‰
log("ğŸ”¨ ãƒãƒ«ã‚³ãƒ•ãƒã‚§ãƒ¼ãƒ³ã‚’æ§‹ç¯‰ä¸­...")

var global_chain = {}
var processed_count = 0

each let note, notes {
	if Core:type(note) == "obj" {
		if note["text"] != null {
			let text = note["text"]

			if text.len >= CONFIG.min_length {
				let cleaned = clean_note_text(text)

				if cleaned.len >= CONFIG.min_length {
					let tokens = tokenize(cleaned, CONFIG.use_word_tokens)
					let chain = build_chain(tokens, CONFIG.markov_order)
					global_chain = merge_chains(global_chain, chain)
					processed_count = processed_count + 1
				}
			}
		}
	}
}

let chain_size = Obj:keys(global_chain).len

log(`âœ… {processed_count} ä»¶ã®ãƒãƒ¼ãƒˆã‹ã‚‰ {chain_size} å€‹ã®çŠ¶æ…‹ã‚’å­¦ç¿’`)
log("")

// 3. æ–‡ç« ç”Ÿæˆ
log("âœ¨ æ–‡ç« ã‚’ç”Ÿæˆã—ã¾ã™...")
log("")
log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")

for let i, CONFIG.generate_count {
	log("")

	let generated = generate_text(
		global_chain
		CONFIG.markov_order
		CONFIG.max_length
		CONFIG.min_length
		CONFIG.use_word_tokens
	)

	log(`ã€{i + 1}ã€‘ {generated}`)
}

log("")
log("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
log("")
log("âœ… ç”Ÿæˆå®Œäº†ï¼")
log("")
log("ğŸ’¡ ãƒ’ãƒ³ãƒˆ:")
log("  - ã‚‚ã£ã¨è‡ªç„¶ãªæ–‡ç« ã«ã—ãŸã„ â†’ ãƒãƒ¼ãƒˆã‚’ã‚‚ã£ã¨æŠ•ç¨¿ã—ã¾ã—ã‚‡ã†")
log("  - è¨­å®šã‚’å¤‰æ›´ã—ãŸã„ â†’ CONFIGå¤‰æ•°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„")
log("")
log("âš ï¸ æ³¨æ„:")
log("  ç”Ÿæˆã•ã‚ŒãŸæ–‡ç« ã¯ã‚ãªãŸã®æ–‡ä½“ã‚’æ¨¡å€£ã—ã¦ã„ã¾ã™ãŒã€")
log("  å®Ÿéš›ã®ã‚ãªãŸã®ç™ºè¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚")
